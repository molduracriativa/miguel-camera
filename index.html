<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Miguel 1 ano</title>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body {
    width: 100%; 
    height: 100%;
    overflow: hidden;
    background: black;
    font-family: Arial, sans-serif;
  }

  /* cÃ¢mera */
  #video {
    position: absolute;
    width: 100vw;
    height: 100vh;
    object-fit: cover;
    background: black;
    z-index: 1;
  }

  /* moldura visual (nÃ£o grava) */
  #overlay {
    position: absolute;
    width: 100vw;
    height: 100vh;
    object-fit: contain;
    pointer-events: none;
    z-index: 2;
  }

  /* botÃµes */
  #buttons {
    position: absolute;
    bottom: 40px;
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 40px;
    z-index: 10;
  }

  button {
    width: 70px;
    height: 70px;
    border: none;
    border-radius: 50%;
    background: white;
    font-size: 26px;
    cursor: pointer;
  }

  /* preview */
  #preview-container {
    position: absolute;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    display: none;
    flex-direction: column;
    align-items: center;
    z-index: 20;
  }

  #photo-preview,
  #video-preview {
    width: 85vw;
    max-width: 350px;
    border-radius: 10px;
    border: 3px solid white;
    margin-bottom: 10px;
  }

  #save-btn,
  #retry-btn {
    background: #4CAF50;
    color: white;
    border-radius: 6px;
    padding: 10px 18px;
    margin-top: 8px;
  }

</style>
</head>

<body>

<video id="video" autoplay playsinline muted></video>
<img id="overlay" src="moldura.png" />

<div id="buttons">
  <button id="switch-camera">ðŸ”„</button>
  <button id="capture">ðŸ“¸</button>
  <button id="record">ðŸŽ¥</button>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<div id="preview-container">
  <img id="photo-preview" style="display:none;" />
  <video id="video-preview" controls style="display:none;"></video>
  <button id="save-btn">Salvar</button>
  <button id="retry-btn">Tentar novamente</button>
</div>

<script>
let video = document.getElementById("video");
let overlay = document.getElementById("overlay");
let canvas = document.getElementById("canvas");

let captureBtn = document.getElementById("capture");
let recordBtn = document.getElementById("record");
let switchCameraBtn = document.getElementById("switch-camera");

let previewContainer = document.getElementById("preview-container");
let photoPreview = document.getElementById("photo-preview");
let videoPreview = document.getElementById("video-preview");

let saveBtn = document.getElementById("save-btn");
let retryBtn = document.getElementById("retry-btn");

let stream;
let usingFront = true;
let recorder;
let chunks = [];
let intervalDraw;

/* ðŸ“Œ Iniciar cÃ¢mera corretamente */
async function startCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());

  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: usingFront ? "user" : "environment" },
    audio: false
  });

  video.srcObject = stream;

  video.style.transform = usingFront ? "scaleX(-1)" : "scaleX(1)";
}

/* ðŸ“Œ Trocar cÃ¢mera */
switchCameraBtn.onclick = () => {
  usingFront = !usingFront;
  startCamera();
};

/* ðŸ“Œ Moldura perfeita sem esticar */
function drawFrame(ctx, W, H) {
  const fw = overlay.naturalWidth;
  const fh = overlay.naturalHeight;

  const fr = fw / fh;
  const cr = W / H;

  let w, h, x, y;

  if (fr > cr) {
    w = W;
    h = W / fr;
    x = 0;
    y = (H - h) / 2;
  } else {
    h = H;
    w = H * fr;
    x = (W - w) / 2;
    y = 0;
  }

  ctx.drawImage(overlay, x, y, w, h);
}

/* ðŸ“¸ Capturar Foto */
captureBtn.onclick = () => {
  const track = stream.getVideoTracks()[0].getSettings();

  canvas.width = track.width;
  canvas.height = track.height;

  let ctx = canvas.getContext("2d");

  if (usingFront) {
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);
  }

  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  ctx.setTransform(1,0,0,1,0,0);
  drawFrame(ctx, canvas.width, canvas.height);

  photoPreview.src = canvas.toDataURL("image/png");
  photoPreview.style.display = "block";
  videoPreview.style.display = "none";
  previewContainer.style.display = "flex";
};

/* ðŸŽ¥ Gravar VÃ­deo */
recordBtn.onclick = () => {
  if (!recorder) startRecording();
  else stopRecording();
};

function startRecording() {
  recordBtn.style.background = "red";

  const track = stream.getVideoTracks()[0].getSettings();

  canvas.width = track.width;
  canvas.height = track.height;

  let ctx = canvas.getContext("2d");

  intervalDraw = setInterval(() => {
    if (usingFront) {
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
    }
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.setTransform(1,0,0,1,0,0);
    drawFrame(ctx, canvas.width, canvas.height);
  }, 33);

  let canvasStream = canvas.captureStream(30);

  recorder = new MediaRecorder(canvasStream, { mimeType: "video/webm" });

  chunks = [];
  recorder.ondataavailable = e => chunks.push(e.data);

  recorder.onstop = () => {
    let blob = new Blob(chunks, { type: "video/webm" });
    videoPreview.src = URL.createObjectURL(blob);

    videoPreview.style.display = "block";
    photoPreview.style.display = "none";
    previewContainer.style.display = "flex";
  };

  recorder.start();
}

function stopRecording() {
  clearInterval(intervalDraw);
  recordBtn.style.background = "white";
  recorder.stop();
  recorder = null;
}

/* ðŸ’¾ Salvar */
saveBtn.onclick = () => {
  const a = document.createElement("a");

  if (photoPreview.style.display === "block") {
    a.href = photoPreview.src;
    a.download = "foto.png";
  } else {
    a.href = videoPreview.src;
    a.download = "video.webm";
  }

  a.click();
};

/* ðŸ”„ Tentar novamente */
retryBtn.onclick = () => {
  previewContainer.style.display = "none";
};

/* ðŸš€ Start */
overlay.onload = () => {
  startCamera();
};
</script>

</body>
</html>
