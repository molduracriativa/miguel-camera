<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Moldura - Foto e V√≠deo MP4 (Final)</title>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    width: 100%;
    height: 100%;
    background: #000;
    overflow: hidden;
    touch-action: manipulation;
    font-family: sans-serif;
  }

  /* Bot√£o que ativa a c√¢mera */
  #enable-camera-btn {
    position: fixed;
    inset: 0;
    margin: auto;
    height: 70px;
    width: 280px;
    background: #4CAF50;
    color: white;
    font-size: 24px;
    border: none;
    border-radius: 16px;
    z-index: 999999;
  }

  #video, #render-canvas, #overlay {
    display: none;
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
    object-fit: cover;
  }

  #overlay {
    pointer-events: none;
  }

  #buttons {
    position: fixed;
    bottom: 40px;
    width: 100%;
    display: none;
    justify-content: center;
    gap: 30px;
    z-index: 99999;
  }

  button.action {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    font-size: 26px;
    border: none;
    background: #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
  }

  #stop-record {
    background: red;
    color: white;
    display: none;
  }

  #preview-container {
    position: fixed;
    bottom: 20px;
    width: 100%;
    display: none;
    flex-direction: column;
    align-items: center;
    z-index: 99999;
  }

  #preview-video, #photo-preview {
    width: 90vw;
    max-width: 360px;
    border: 3px solid white;
    border-radius: 12px;
    margin-bottom: 10px;
  }

  #save-btn, #retry-btn {
    background: #4CAF50;
    color: white;
    padding: 12px 25px;
    border-radius: 8px;
    font-size: 18px;
    border: none;
    width: 200px;
    margin-bottom: 6px;
  }
</style>
</head>

<body>

<!-- O √∫nico elemento que aparece no in√≠cio -->
<button id="enable-camera-btn">Ativar C√¢mera</button>

<video id="video" autoplay playsinline muted></video>
<img id="overlay" src="moldura.png">
<canvas id="render-canvas"></canvas>

<div id="buttons">
  <button id="switch-camera" class="action">üîÑ</button>
  <button id="capture" class="action">üì∏</button>
  <button id="record" class="action">üé•</button>
  <button id="stop-record" class="action">‚èπÔ∏è</button>
</div>

<div id="preview-container">
  <video id="preview-video" controls></video>
  <img id="photo-preview" />
  <button id="save-btn">Salvar</button>
  <button id="retry-btn">Tentar novamente</button>
</div>

<!-- FFmpeg para converter WEBM -> MP4 -->
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.5/dist/ffmpeg.min.js"></script>

<script>
let stream;
let recorder;
let chunks = [];
let usingFront = true;

// FFmpeg
const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log: false });

// Safari/Android touch unlock
document.addEventListener("touchstart", () => {}, { passive: true });
document.addEventListener("click", () => {}, true);

// -----------------------------------------------
// ATIVAR C√ÇMERA ‚Äî GARANTIDO FUNCIONAL
// -----------------------------------------------
document.getElementById("enable-camera-btn").onclick = async () => {
  try {
    await startCamera();

    // Mostrar interface
    video.style.display = "block";
    overlay.style.display = "block";
    renderCanvas.style.display = "block";
    document.getElementById("buttons").style.display = "flex";

    // Esconder bot√£o
    enableCameraBtn.style.display = "none";

  } catch (e) {
    alert("Erro ao acessar c√¢mera: " + e.name);
    console.error(e);
  }
};

// -----------------------------------------------
// FUN√á√ÉO CAMERA
// -----------------------------------------------
async function startCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());

  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: usingFront ? "user" : "environment" },
    audio: true
  });

  video.srcObject = stream;
  video.muted = true;
  video.setAttribute("playsinline", "");
  await video.play();
  video.style.transform = usingFront ? "scaleX(-1)" : "scaleX(1)";
}

// TROCAR C√ÇMERA
switchCamera.onclick = () => {
  usingFront = !usingFront;
  startCamera();
};

// -----------------------------------------------
// FOTO
// -----------------------------------------------
capture.onclick = () => {
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const ctx = canvas.getContext("2d");

  if (usingFront) {
    ctx.save();
    ctx.scale(-1, 1);
    ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
    ctx.restore();
  } else {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  }

  ctx.drawImage(overlay, 0, 0, canvas.width, canvas.height);

  photoPreview.src = canvas.toDataURL("image/png");

  previewVideo.style.display = "none";
  photoPreview.style.display = "block";
  previewContainer.style.display = "flex";
};

// -----------------------------------------------
// GRAVA√á√ÉO
// -----------------------------------------------
record.onclick = () => {
  renderCanvas.width = video.videoWidth;
  renderCanvas.height = video.videoHeight;

  const ctx = renderCanvas.getContext("2d");

  function draw() {
    ctx.clearRect(0, 0, renderCanvas.width, renderCanvas.height);

    if (usingFront) {
      ctx.save();
      ctx.scale(-1, 1);
      ctx.drawImage(video, -renderCanvas.width, 0, renderCanvas.width, renderCanvas.height);
      ctx.restore();
    } else {
      ctx.drawImage(video, 0, 0, renderCanvas.width, renderCanvas.height);
    }

    ctx.drawImage(overlay, 0, 0, render
