const video = document.getElementById("camera");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");

let mediaRecorder;
let recordedChunks = [];
let canvasStream;
let camStream;

// Configurações compatíveis para iOS + Android
async function iniciarCamera() {
    try {
        camStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
            video: {
                facingMode: "user", 
                width: { ideal: 1080 },
                height: { ideal: 1920 }
            }
        });

        video.srcObject = camStream;
    } catch (err) {
        alert("Erro ao acessar a câmera: " + err);
    }
}

iniciarCamera();

// Criar canvas que combinará câmera + moldura
function criarCanvasStream() {
    const canvas = document.createElement("canvas");
    canvas.width = 1080;
    canvas.height = 1920;

    const ctx = canvas.getContext("2d");

    const frame = document.getElementById("frame");

    function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Render camera
        ctx.save();
        ctx.scale(-1, 1);
        ctx.drawImage(video, -1080, 0, 1080, 1920);
        ctx.restore();

        // Render moldura sem esticar
        ctx.drawImage(frame, 0, 0, 1080, 1920);

        requestAnimationFrame(render);
    }
    render();

    return canvas.captureStream(30);
}

startBtn.onclick = () => {
    canvasStream = criarCanvasStream();

    // Junta áudio real da câmera
    const audioTrack = camStream.getAudioTracks()[0];
    canvasStream.addTrack(audioTrack);

    recordedChunks = [];
    mediaRecorder = new MediaRecorder(canvasStream, {
        mimeType: "video/webm;codecs=vp9"
    });

    mediaRecorder.ondataavailab
